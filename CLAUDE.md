# One Percent Stats

This repository contains the source code for the One Percent Stats application, a web-based analytics dashboard for tracking and visualizing leads data.

## Coding Guidelines

- **Language**: The project is written in TypeScript.
- **Frameworks**:
  - **Backend**: Hono on Cloudflare Workers.
  - **Frontend**: React with Vite.
- **Database**: D1, Cloudflare's serverless database.
- **ORM**: Drizzle ORM.
- **Authentication**: better-auth.
- **UI Components**: shadcn/ui with Tailwind CSS.
- **Linting and Formatting**: Biome.
- **Package Manager**: Always use Bun instead of npm for all package management and script execution.

## UI Component Guidelines

- **Component Library**: Use shadcn/ui components for consistent design system
- **Available Components**: Badge, Button, Card, Dialog, Table, Skeleton, and more in `src/components/ui/`
- **Component Priority**: Always try to use existing shadcn/ui components first. If unsure about available components, browse https://ui.shadcn.com/docs/components to check for new or additional components that might be useful
- **Charts**: Use shadcn/ui Chart components built on Recharts for data visualization. Supports Bar, Line, Area, Pie charts with built-in theming, tooltips, and legends
- **Styling**: Tailwind CSS with custom CSS variables for theming
- **Patterns**:
  - Use Badge components for status indicators (platform, status, etc.)
  - Implement Dialog components for detailed views and modals
  - Apply proper truncation with clickable rows for data tables
  - Include hover states and transitions for better UX
  - Use proper event handling with `stopPropagation()` for nested interactive elements
  - For charts, use ChartContainer, ChartTooltip, ChartLegend components with proper chart config

## Codebase Layout

The repository is a monorepo managed by Bun. It is divided into two main applications: `apps/server` and `apps/web`.

### `apps/server`

This directory contains the backend application.

- **`src/`**: The source code for the server.
  - **`db/`**: Contains the database schema, migrations, and connection logic.
    - **`migrations/`**: Database migration files generated by Drizzle Kit.
    - **`schema/`**: Drizzle ORM schema definitions for the database tables.
    - **`index.ts`**: The main database connection file.
    - **`script-db.ts`**: A separate database connection for running local scripts.
  - **`lib/`**: Contains shared libraries and utilities.
    - **`auth.ts`**: The authentication configuration using `better-auth`.
  - **`routers/`**: Hono router definitions for different API endpoints.
    - **`analytics.ts`**: API endpoints for the analytics dashboard.
    - **`index.ts`**: The main router file.
  - **`scripts/`**: Scripts for various tasks, such as importing data.
    - **`create-db-from-sql.ts`**: A script to create a local database from a SQL file.
    - **`import-leads.ts`**: A script to import leads data from a CSV file.
  - **`index.ts`**: The main entry point for the server application.
- **`.env.example`**: An example environment file.
- **`drizzle.config.ts`**: The configuration file for Drizzle Kit.
- **`package.json`**: The dependencies and scripts for the server application.
- **`tsconfig.json`**: The TypeScript configuration for the server.
- **`worker-configuration.d.ts`**: Type definitions for the Cloudflare Worker environment.
- **`wrangler.jsonc`**: The configuration file for Cloudflare Workers.

### `apps/web`

This directory contains the frontend application.

- **`public/`**: Public assets for the web application.
- **`src/`**: The source code for the frontend.
  - **`components/`**: Reusable React components.
    - **`ui/`**: shadcn/ui components (Badge, Button, Card, Dialog, Table, etc.)
    - **`header.tsx`**, **`theme-provider.tsx`**, etc.: Custom application components
  - **`lib/`**: Shared libraries and utilities for the frontend.
    - **`utils.ts`**: Utility functions including `cn()` for className merging
    - **`auth-client.ts`**: Authentication client configuration
  - **`routes/`**: The pages of the application.
    - **`dashboard.tsx`**: Main dashboard with leads table and analytics
    - **`login.tsx`**: Authentication page
  - **`index.css`**: The main stylesheet with Tailwind CSS and custom properties.
  - **`root.tsx`**: The root component of the application.
  - **`routes.ts`**: The route definitions for the application.
- **`.env.example`**: An example environment file.
- **`package.json`**: The dependencies and scripts for the web application.
- **`tsconfig.json`**: The TypeScript configuration for the web application.
- **`vite.config.ts`**: The configuration file for Vite.
- **`wrangler.jsonc`**: The configuration file for deploying the frontend to Cloudflare Pages.

### Root

- **`.gitignore`**: A list of files and directories to ignore in Git.
- **`biome.json`**: The configuration file for Biome.
- **`bun.lock`**: The lockfile for Bun.
- **`package.json`**: The root `package.json` file for the monorepo.
- **`README.md`**: The main README file for the project.
- **`turbo.json`**: The configuration file for Turborepo.

## Database Operations

### Querying the Remote D1 Database

The project uses Cloudflare D1 as the database. You can query the remote database directly using the Wrangler CLI.

#### Basic Query Commands

```bash
# Navigate to the server directory
cd apps/server

# Query the remote database (replace with your actual database name)
wrangler d1 execute onepercent-stats-new --remote --command "SELECT * FROM leads LIMIT 5"

# Get table structure
wrangler d1 execute onepercent-stats-new --remote --command "PRAGMA table_info(leads)"

# Count total records
wrangler d1 execute onepercent-stats-new --remote --command "SELECT COUNT(*) as total FROM leads"
```

#### Common Queries

```bash
# Get leads by platform
wrangler d1 execute onepercent-stats-new --remote --command "SELECT platform, COUNT(*) as count FROM leads GROUP BY platform ORDER BY count DESC"

# Get conversion data
wrangler d1 execute onepercent-stats-new --remote --command "SELECT is_closed, COUNT(*) as count, SUM(sales) as total_sales FROM leads GROUP BY is_closed"

# Get recent leads
wrangler d1 execute onepercent-stats-new --remote --command "SELECT id, name, platform, sales, created_at FROM leads ORDER BY created_at DESC LIMIT 10"

# Get leads with sales data
wrangler d1 execute onepercent-stats-new --remote --command "SELECT * FROM leads WHERE sales > 0 ORDER BY sales DESC"
```

#### Database Schema

The main tables in the database:

**leads table:**
- `id` (INTEGER, PRIMARY KEY)
- `month` (TEXT) - Month name (e.g., "May", "June")
- `date` (TEXT) - Date in DD/MM/YYYY format
- `name` (TEXT) - Lead's name
- `phone_number` (TEXT) - Phone number
- `platform` (TEXT) - Marketing platform (Facebook, Google, etc.)
- `is_closed` (INTEGER) - Boolean (0/1) indicating if lead is closed
- `status` (TEXT) - Lead status
- `sales` (INTEGER) - Sales amount in RM
- `remark` (TEXT) - Additional notes
- `trainer_handle` (TEXT) - Trainer identifier
- `closed_date` (TEXT) - Date when lead was closed (DD/MM/YYYY)
- `closed_month` (TEXT) - Month when lead was closed
- `closed_year` (TEXT) - Year when lead was closed
- `created_at` (TEXT) - Timestamp when record was created

**advertising_costs table:**
- `id` (INTEGER, PRIMARY KEY)
- `month` (INTEGER) - Month number (1-12)
- `year` (INTEGER) - Year
- `cost` (REAL) - Advertising cost amount
- `currency` (TEXT) - Currency (default "RM")
- `created_at` (TEXT) - Creation timestamp
- `updated_at` (TEXT) - Last update timestamp

#### Database Migrations

```bash
# Apply pending migrations to remote database
wrangler d1 migrations apply onepercent-stats-new --remote

# Check migration status
wrangler d1 execute onepercent-stats-new --remote --command "SELECT * FROM __drizzle_migrations"

# Generate new migration (after schema changes)
cd apps/server
bun run db:generate
```

#### Local vs Remote Database

```bash
# Query local database (remove --remote flag)
wrangler d1 execute onepercent-stats-new --command "SELECT COUNT(*) FROM leads"

# Apply migrations locally
wrangler d1 migrations apply onepercent-stats-new --local
```

#### Data Backup and Export

```bash
# Export data to SQL file
wrangler d1 export onepercent-stats-new --remote --output backup.sql

# Import data from SQL file
wrangler d1 execute onepercent-stats-new --remote --file backup.sql
```

#### Troubleshooting

- **Column not found errors**: Check if migrations have been applied with `wrangler d1 migrations apply`
- **Permission errors**: Ensure you're logged in with `wrangler login`
- **Database not found**: Verify the database name in `wrangler.jsonc` matches the command
- **Syntax errors**: Use proper SQL syntax and escape quotes in complex queries
