# One Percent Stats

This repository contains the source code for the One Percent Stats application, a web-based analytics dashboard for tracking and visualizing leads data.

## ðŸŽ¯ Quick Reference

**Language**: TypeScript  
**Package Manager**: Bun (not npm/yarn/pnpm)  
**Backend**: Hono on Cloudflare Workers  
**Frontend**: React with Vite (see `apps/web/CLAUDE.md` for detailed web guidelines)  
**Database**: D1 (Cloudflare's serverless database)  
**ORM**: Drizzle ORM  
**Authentication**: better-auth  
**Linting**: Biome

## ðŸ—ï¸ Monorepo Structure

The repository is a monorepo managed by Bun and Turborepo, divided into two main applications: `apps/server` and `apps/web`.

### Essential Commands

```bash
# Development
bun run dev              # Start both server and web in development
bun run server:dev       # Start only server
bun run web:dev          # Start only web

# Build
bun run build            # Build both applications
bun run server:build     # Build only server
bun run web:build        # Build only web

# Database operations (from apps/server)
cd apps/server
bun run db:generate      # Generate migrations after schema changes
bun run db:migrate       # Apply migrations locally
```

### `apps/server`

This directory contains the backend application.

- **`src/`**: The source code for the server.
  - **`db/`**: Contains the database schema, migrations, and connection logic.
    - **`migrations/`**: Database migration files generated by Drizzle Kit.
    - **`schema/`**: Drizzle ORM schema definitions for the database tables.
    - **`index.ts`**: The main database connection file.
    - **`script-db.ts`**: A separate database connection for running local scripts.
  - **`lib/`**: Contains shared libraries and utilities.
    - **`auth.ts`**: The authentication configuration using `better-auth`.
  - **`routers/`**: Hono router definitions for different API endpoints.
    - **`analytics.ts`**: API endpoints for the analytics dashboard.
    - **`index.ts`**: The main router file.
  - **`scripts/`**: Scripts for various tasks, such as importing data.
    - **`create-db-from-sql.ts`**: A script to create a local database from a SQL file.
    - **`import-leads.ts`**: A script to import leads data from a CSV file.
  - **`index.ts`**: The main entry point for the server application.
- **`.env.example`**: An example environment file.
- **`drizzle.config.ts`**: The configuration file for Drizzle Kit.
- **`package.json`**: The dependencies and scripts for the server application.
- **`tsconfig.json`**: The TypeScript configuration for the server.
- **`worker-configuration.d.ts`**: Type definitions for the Cloudflare Worker environment.
- **`wrangler.jsonc`**: The configuration file for Cloudflare Workers.

### `apps/web`

This directory contains the frontend React application built with Vite. 

**ðŸ“‹ For detailed web development guidelines, component usage, authentication patterns, and styling conventions, see `apps/web/CLAUDE.md`.**

## ðŸ“š Documentation Structure

- **Root CLAUDE.md** (this file): Monorepo overview, database operations, server guidelines
- **`apps/web/CLAUDE.md`**: Frontend development guidelines, UI components, authentication
- **`apps/server/`**: Backend-specific documentation and configurations

### Root

- **`.gitignore`**: A list of files and directories to ignore in Git.
- **`biome.json`**: The configuration file for Biome.
- **`bun.lock`**: The lockfile for Bun.
- **`package.json`**: The root `package.json` file for the monorepo.
- **`README.md`**: The main README file for the project.
- **`turbo.json`**: The configuration file for Turborepo.

## Database Operations

### Querying the Remote D1 Database

The project uses Cloudflare D1 as the database. You can query the remote database directly using the Wrangler CLI.

#### Basic Query Commands

```bash
# Navigate to the server directory
cd apps/server

# Query the remote database (replace with your actual database name)
wrangler d1 execute onepercent-stats-new --remote --command "SELECT * FROM leads LIMIT 5"

# Get table structure
wrangler d1 execute onepercent-stats-new --remote --command "PRAGMA table_info(leads)"

# Count total records
wrangler d1 execute onepercent-stats-new --remote --command "SELECT COUNT(*) as total FROM leads"
```

#### Common Queries

```bash
# Get leads by platform
wrangler d1 execute onepercent-stats-new --remote --command "SELECT platform, COUNT(*) as count FROM leads GROUP BY platform ORDER BY count DESC"

# Get conversion data
wrangler d1 execute onepercent-stats-new --remote --command "SELECT is_closed, COUNT(*) as count, SUM(sales) as total_sales FROM leads GROUP BY is_closed"

# Get recent leads
wrangler d1 execute onepercent-stats-new --remote --command "SELECT id, name, platform, sales, created_at FROM leads ORDER BY created_at DESC LIMIT 10"

# Get leads with sales data
wrangler d1 execute onepercent-stats-new --remote --command "SELECT * FROM leads WHERE sales > 0 ORDER BY sales DESC"
```

#### Database Schema

The main tables in the database:

**leads table:**
- `id` (INTEGER, PRIMARY KEY)
- `month` (TEXT) - Month name (e.g., "May", "June")
- `date` (TEXT) - Date in DD/MM/YYYY format
- `name` (TEXT) - Lead's name
- `phone_number` (TEXT) - Phone number
- `platform` (TEXT) - Marketing platform (Facebook, Google, etc.)
- `is_closed` (INTEGER) - Boolean (0/1) indicating if lead is closed
- `status` (TEXT) - Lead status
- `sales` (INTEGER) - Sales amount in RM
- `remark` (TEXT) - Additional notes
- `trainer_handle` (TEXT) - Trainer identifier
- `closed_date` (TEXT) - Date when lead was closed (DD/MM/YYYY)
- `closed_month` (TEXT) - Month when lead was closed
- `closed_year` (TEXT) - Year when lead was closed
- `created_at` (TEXT) - Timestamp when record was created

**advertising_costs table:**
- `id` (INTEGER, PRIMARY KEY)
- `month` (INTEGER) - Month number (1-12)
- `year` (INTEGER) - Year
- `cost` (REAL) - Advertising cost amount
- `currency` (TEXT) - Currency (default "RM")
- `created_at` (TEXT) - Creation timestamp
- `updated_at` (TEXT) - Last update timestamp

#### Database Migrations

```bash
# Apply pending migrations to remote database
wrangler d1 migrations apply onepercent-stats-new --remote

# Check migration status
wrangler d1 execute onepercent-stats-new --remote --command "SELECT * FROM __drizzle_migrations"

# Generate new migration (after schema changes)
cd apps/server
bun run db:generate
```

#### Local vs Remote Database

```bash
# Query local database (remove --remote flag)
wrangler d1 execute onepercent-stats-new --command "SELECT COUNT(*) FROM leads"

# Apply migrations locally
wrangler d1 migrations apply onepercent-stats-new --local
```

#### Data Backup and Export

```bash
# Export data to SQL file
wrangler d1 export onepercent-stats-new --remote --output backup.sql

# Import data from SQL file
wrangler d1 execute onepercent-stats-new --remote --file backup.sql
```

#### Cloudflare Authentication

**IMPORTANT**: Do NOT use `wrangler login` for authentication. Instead, use the API token from the `.env` file.

The project uses API token authentication which is automatically read from the `.env` file in `apps/server/`:
- `CLOUDFLARE_D1_TOKEN` - API token for D1 database access
- `CLOUDFLARE_API_KEY` - Same token value for API access
- `CLOUDFLARE_ACCOUNT_ID` - Account ID for Cloudflare operations
- `CLOUDFLARE_DATABASE_ID` - Database ID for the D1 database

Wrangler automatically reads these environment variables, so no manual authentication is needed.

#### Export/Import Data Between Remote and Local

```bash
# Export full database from remote
cd apps/server
wrangler d1 export onepercent-stats-new --remote --output=./backup.sql

# Export only data (no schema)
wrangler d1 export onepercent-stats-new --remote --output=./data-only.sql --no-schema

# Export only schema (no data)
wrangler d1 export onepercent-stats-new --remote --output=./schema-only.sql --no-data

# Import to local database (after clearing existing data)
wrangler d1 execute onepercent-stats-new --local --file=./backup.sql

# Clear local database tables before import
wrangler d1 execute onepercent-stats-new --local --command "DROP TABLE IF EXISTS leads; DROP TABLE IF EXISTS advertising_costs; DROP TABLE IF EXISTS account; DROP TABLE IF EXISTS session; DROP TABLE IF EXISTS verification; DROP TABLE IF EXISTS user;"
```

#### Troubleshooting

- **Column not found errors**: Check if migrations have been applied with `wrangler d1 migrations apply`
- **Authentication errors**: Verify the API token in `.env` file is correct and has proper permissions
- **Database not found**: Verify the database name in `wrangler.jsonc` matches the command
- **Syntax errors**: Use proper SQL syntax and escape quotes in complex queries
- **Import errors with timestamps**: Exported SQL may have unquoted timestamp values that need to be fixed before import
